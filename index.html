<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Option Move Calculator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      padding: 20px;
    }
    h1, h2 { color: #93c5fd; }
    .box {
      background: #020617;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 6px;
    }
    label {
      display: block;
      margin-bottom: 8px;
    }
    input, select, button {
      width: 100%;
      padding: 6px;
      margin-top: 4px;
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #334155;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      margin-top: 10px;
      cursor: pointer;
    }
    #output {
      font-size: 1.1em;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <h1>My Quant's Option Calculator</h1>

  <div class="box">
    <label>Underlying Price
      <input id="underlying" type="number" step="0.01" />
    </label>

    <label>Option Price (mid)
      <input id="optionPrice" type="number" step="0.01" />
    </label>

    <label>Delta
      <input id="delta" type="number" step="0.0001" />
    </label>

    <label>Gamma
      <input id="gamma" type="number" step="0.0001" />
    </label>

    <label>Theta (per day)
      <input id="theta" type="number" step="0.0001" />
    </label>
  </div>

  <div class="box">
    <h2>Target</h2>

    <label>Target Option Price
      <input id="targetPrice" type="number" step="0.01" />
    </label>

    <label>Time Horizon
      <select id="timeHorizon">
        <option value="0">Now</option>
        <option value="1">1 day</option>
        <option value="2">2 days</option>
        <option value="3">3 days</option>
        <option value="4">4 days</option>
        <option value="5">5 days</option>
      </select>
    </label>

    <button id="calculate">Calculate Required Move</button>
  </div>

  <div class="box" id="output"></div>

  <script>
    function clamp(x, lo, hi) {
      return Math.max(lo, Math.min(hi, x));
    }

    function solveMoveWithGreekDrift({
      optionPrice,
      targetPrice,
      delta0,
      gamma0,
      theta0,
      timeDays
    }) {
      const steps = 80;
      const gammaFloor = 1e-6;
      const baseShape = Math.max(0.01, Math.abs(delta0) * (1 - Math.abs(delta0)));

      function simulate(dx) {
        let price = optionPrice;
        let d = delta0;
        let g = gamma0;
        let th = theta0;

        const step = dx / steps;
        const dt = timeDays / steps;

        for (let i = 0; i < steps; i++) {
          price += d * step + 0.5 * g * step * step + th * dt;
          d = clamp(d + g * step, -1, 1);

          const shape = Math.max(0.01, Math.abs(d) * (1 - Math.abs(d)));
          g = Math.max(gammaFloor, gamma0 * (shape / baseShape));

          th = theta0 * (g / gamma0);
        }
        return { price, delta: d, gamma: g, theta: th };
      }

      let lo = -200, hi = 200;
      function f(x) { return simulate(x).price - targetPrice; }

      let flo = f(lo), fhi = f(hi), tries = 0;
      while (flo * fhi > 0 && tries < 10) {
        lo *= 1.6; hi *= 1.6;
        flo = f(lo); fhi = f(hi);
        tries++;
      }
      if (flo * fhi > 0) return null;

      for (let i = 0; i < 60; i++) {
        const mid = (lo + hi) / 2;
        const fmid = f(mid);
        if (Math.abs(fmid) < 1e-6) {
          const res = simulate(mid);
          return { move: mid, ...res };
        }
        if (flo * fmid <= 0) { hi = mid; fhi = fmid; }
        else { lo = mid; flo = fmid; }
      }

      const finalMove = (lo + hi) / 2;
      return { move: finalMove, ...simulate(finalMove) };
    }

    function frozenGreeksMin(optionPrice, delta, gamma, theta, timeDays) {
      const a = 0.5 * gamma;
      if (Math.abs(a) < 1e-12) return null;

      const dxStar = -delta / (2 * a);
      const minChange = delta * dxStar + a * dxStar * dxStar + theta * timeDays;
      return { dxStar, minPrice: optionPrice + minChange };
    }

    function requiredStockMove({ optionPrice, targetPrice, delta, gamma, theta, timeDays }) {
      const dC = targetPrice - optionPrice;
      const a = 0.5 * gamma;
      const b = delta;
      const c = theta * timeDays - dC;

      if (Math.abs(a) < 1e-12) return Math.abs(b) < 1e-12 ? null : -c / b;

      const disc = b * b - 4 * a * c;
      if (disc < 0) return null;

      const s = Math.sqrt(disc);
      const r1 = (-b + s) / (2 * a);
      const r2 = (-b - s) / (2 * a);
      return Math.abs(r1) < Math.abs(r2) ? r1 : r2;
    }

    const calcBtn = document.getElementById('calculate');
    const output = document.getElementById('output');

    calcBtn.onclick = () => {
      const underlying  = parseFloat(underlying.value);
      const optionPrice = parseFloat(optionPrice.value);
      const targetPrice = parseFloat(targetPrice.value);
      const deltaVal    = parseFloat(delta.value);
      const gammaVal    = parseFloat(gamma.value);
      const thetaVal    = parseFloat(theta.value);
      const timeDays    = parseFloat(timeHorizon.value);

      if ([underlying, optionPrice, targetPrice, deltaVal, gammaVal, thetaVal, timeDays].some(isNaN)) {
        output.textContent = "Please fill in all fields.";
        return;
      }

      const move = requiredStockMove({
        optionPrice,
        targetPrice,
        delta: deltaVal,
        gamma: gammaVal,
        theta: thetaVal,
        timeDays
      });

      if (move === null) {
        const est = solveMoveWithGreekDrift({
          optionPrice,
          targetPrice,
          delta0: deltaVal,
          gamma0: gammaVal,
          theta0: thetaVal,
          timeDays
        });

        if (!est) {
          const lim = frozenGreeksMin(optionPrice, deltaVal, gammaVal, thetaVal, timeDays);
          output.textContent = lim
            ? `Closest estimate:\nUnderlying ≈ ${(underlying + lim.dxStar).toFixed(2)}\nOption ≈ ${lim.minPrice.toFixed(2)}`
            : "No estimate available.";
          return;
        }

        output.textContent =
          `Estimated underlying price: ${(underlying + est.move).toFixed(2)}\n\n` +
          `Estimated Greeks:\n` +
          `• Delta ≈ ${est.delta.toFixed(4)}\n` +
          `• Gamma ≈ ${est.gamma.toFixed(6)}\n` +
          `• Theta/day ≈ ${est.theta.toFixed(4)}`;
        return;
      }

      output.textContent =
        `Required underlying move: ${move.toFixed(2)}\n` +
        `Target underlying price: ${(underlying + move).toFixed(2)}`;
    };
  </script>
</body>
</html>
